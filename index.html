<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>üèÅ Enrollment Race to 550</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
  /* =====================================================
     üé® THEME VARIABLES (UPDATED BY JS)
     ===================================================== */
  :root {
    --bg1: #86efac;
    --bg2: #a7f3d0;
    --primary: #ef4444;
    --accent: #22c55e;
  }

  html,
  body {
    overflow-x: hidden;
  }
  body {
    margin: 0;
    padding: 60px 16px 140px;
    font-family: Arial, sans-serif;
    background: repeating-linear-gradient(
      90deg,
      var(--bg1) 0 60px,
      var(--bg2) 60px 120px
    );
    text-align: center;
  }

  body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 26px;
    background: repeating-linear-gradient(90deg, #000 0 20px, #fff 20px 40px);
    z-index: 999;
  }

  #falling-layer {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;
    overflow: hidden;
  }
  .falling {
    position: absolute;
    top: -40px;
    opacity: 0.85;
    animation: fall linear forwards;
  }
  @keyframes fall {
    to {
      transform: translateY(110vh) rotate(360deg);
    }
  }
  body > *:not(#falling-layer) {
    position: relative;
    z-index: 2;
  }

  h1 {
    color: var(--primary);
    font-size: 40px;
    margin-bottom: 12px;
  }

  .buttons button {
    margin: 6px;
    padding: 10px 18px;
    border-radius: 16px;
    border: none;
    font-weight: bold;
    cursor: pointer;
  }
  .buttons button.active {
    background: var(--accent);
    color: white;
  }

  #topRow {
    display: grid;
    grid-template-columns: 260px 1fr 260px;
    gap: 16px;
    max-width: 1100px;
    margin: 20px auto 30px;
    align-items: center;
  }
  .card {
    background: #fff;
    padding: 20px;
    border-radius: 22px;
    box-shadow: 0 10px 26px rgba(0, 0, 0, 0.15);
    position: relative;
  }
  .team {
    border: 4px solid var(--primary);
  }

  .progress {
    background: #e5e7eb;
    height: 20px;
    border-radius: 14px;
    margin: 12px 0;
    position: relative;
  }
  .bar {
    height: 100%;
    background: linear-gradient(90deg, #facc15, var(--accent));
    transition: width 0.6s ease;
    border-radius: 14px;
    position: relative;
  }
  .car {
    position: absolute;
    top: 50%;
    left: calc(var(--pct, 0%) - 12px);
    transform: translateY(-50%) scaleX(-1);
    font-size: 18px;
  }

  #dashboard {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    max-width: 1200px;
    margin: 0 auto 30px;
  }
  .leader {
    transform: scale(1.05);
    border: 4px solid #f59e0b;
  }

  #mvp {
    border: 4px solid #f59e0b;
    font-size: 20px;
    font-weight: bold;
  }
  #mvp.active {
    animation: glow 1.4s infinite;
  }
  @keyframes glow {
    0% { box-shadow: 0 0 10px #fde047; }
    50% { box-shadow: 0 0 30px #facc15; }
    100% { box-shadow: 0 0 10px #fde047; }
  }

  .mvp-badge {
    position: absolute;
    top: -12px;
    right: -12px;
    background: #facc15;
    color: #78350f;
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: bold;
  }

  #managersHeader {
    font-size: 22px;
    font-weight: bold;
    color: #1d4ed8;
    margin-bottom: 14px;
  }
  #managers {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    max-width: 900px;
    margin: 0 auto;
  }
  .manager-card {
    border: 3px solid #2563eb;
  }

  #podium {
    border: 4px solid silver;
    font-size: 18px;
  }
  .podium-row {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    font-weight: bold;
  }

  #lapCounter {
    position: fixed;
    bottom: 5px;
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    padding: 6px 12px;
    border-radius: 12px;
    font-weight: bold;
    font-size: 12px;
    width: auto;
    max-width: 200px;
    text-align: center;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
    z-index: 1000;
  }

  /* Month dropdown for YTD */
  #monthDropdown {
    margin: 10px 0;
    display: none;
  }
  #monthDropdown select {
    padding: 8px 12px;
    border-radius: 12px;
    border: 1px solid #ccc;
    font-weight: bold;
  }
</style>
</head>

<body>
<div id="falling-layer"></div>

<h1>üèÅ Enrollment Race to 550</h1>

<div class="buttons">
  <button onclick="setView('ytd', this)">Year to Date</button>
  <button class="active" onclick="setView('month', this)">This Month</button>
  <button onclick="setView('week', this)">This Week</button>
</div>

<div id="monthDropdown">
  <select onchange="setYearMonth(this.value)">
    <option value="">--Select Month--</option>
  </select>
</div>

<div class="buttons" id="weekSelector" style="display: none;"></div>

<div id="topRow">
  <div id="mvp" class="card"></div>
  <div id="team"></div>
  <div id="podium" class="card"></div>
</div>

<div id="dashboard"></div>
<div id="managersHeader">‚≠ê Managers</div>
<div id="managers"></div>
<div id="lapCounter"></div>

<script>
  const TEAM_GOAL = 550;
  const MANAGERS = ["Sabrina", "Edward", "Teresita"];
  const CURRENT_DATE = new Date();
  const CURRENT_MONTH = CURRENT_DATE.toLocaleString("default", { month: "long" });

  const YEARLY_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTDtYk0GQ5RzrRT_SBmcjH1TfE3k_kHJ5Sd7nmnoKr81UiDPHXF42gd46qCAuAW5hpwjdKC-6-P8bji/pub?gid=1984389436&single=true&output=csv";
  const WEEKLY_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTDtYk0GQ5RzrRT_SBmcjH1TfE3k_kHJ5Sd7nmnoKr81UiDPHXF42gd46qCAuAW5hpwjdKC-6-P8bji/pub?gid=0&single=true&output=csv";

  const MONTH_THEMES = {
    1: { bg1: "#fecdd3", bg2: "#ffe4e6", primary: "#e11d48", accent: "#fb7185", emoji: "üíñ", confetti: true },
    2: { bg1: "#d1fae5", bg2: "#a7f3d0", primary: "#166534", accent: "#22c55e", emoji: "üçÄ", confetti: true },
    9: { bg1: "#fcd34d", bg2: "#fbbf24", primary: "#b45309", accent: "#dc2626", emoji: "üéÉ", confetti: false },
    11: { bg1: "#fee2e2", bg2: "#fef2f2", primary: "#b91c1c", accent: "#16a34a", emoji: "üéÑ", confetti: true }
  };

  const FALLING_THEMES = {
    1: ["üíñ", "üíï", "üåπ"], 2: ["üçÄ", "üåà", "ü™ô"], 9: ["üéÉ", "üç¨", "ü¶á"], 11: ["‚ùÑÔ∏è", "‚≠ê", "üéÑ"]
  };

  function applyTheme() {
    const theme = MONTH_THEMES[CURRENT_DATE.getMonth()] || { bg1:"#86efac", bg2:"#a7f3d0", primary:"#ef4444", accent:"#22c55e", emoji:"üèÅ", confetti:false };
    document.documentElement.style.setProperty("--bg1", theme.bg1);
    document.documentElement.style.setProperty("--bg2", theme.bg2);
    document.documentElement.style.setProperty("--primary", theme.primary);
    document.documentElement.style.setProperty("--accent", theme.accent);
    document.querySelector("h1").innerText = `${theme.emoji} Enrollment Race to 550 ${theme.emoji}`;
    if(theme.confetti) { fire(); }
  }

  function startFallingTheme() {
    const items = FALLING_THEMES[CURRENT_DATE.getMonth()];
    if(!items) return;
    const layer = document.getElementById("falling-layer");
    setInterval(() => {
      const el = document.createElement("div");
      el.className = "falling";
      el.innerText = items[Math.floor(Math.random()*items.length)];
      el.style.left = Math.random()*100+"vw";
      el.style.fontSize = 16 + Math.random()*20 + "px";
      el.style.animationDuration = 6 + Math.random()*6 + "s";
      layer.appendChild(el);
      setTimeout(()=>el.remove(), 12000);
    }, 500);
  }

  let view="month", weeklyData=[], selectedWeek=null, selectedYearMonth=null;
  let lastMVP=null, celebrated={};
  const pct=(a,b)=>(b?Math.min(100,Math.round((a/b)*100)):0);
  const fire=()=>confetti({ particleCount:140, spread:90, origin:{y:0.6} });

  function setView(v, btn){
    view=v; selectedWeek=null; selectedYearMonth=null;
    document.querySelectorAll(".buttons button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById("weekSelector").style.display = v==="week"?"block":"none";
    document.getElementById("monthDropdown").style.display = v==="ytd"?"block":"none";
    if(v==="ytd") populateMonthDropdown();
    loadData();
  }

  function setWeek(w, btn){
    selectedWeek=w;
    document.querySelectorAll("#weekSelector button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    loadData();
  }

  function setYearMonth(month){ selectedYearMonth=month; loadData(); }

  function populateMonthDropdown(){
    const select = document.querySelector("#monthDropdown select");
    select.innerHTML='<option value="">--Select Month--</option>';
    const months = Array.from(new Set(weeklyData.map(r=>r.month)));
    months.forEach(m=>{
      const option=document.createElement("option"); option.value=m; option.innerText=m;
      if(m===selectedYearMonth) option.selected=true;
      select.appendChild(option);
    });
  }

  function renderWeekButtons(){
    const weekSelector=document.getElementById("weekSelector");
    weekSelector.innerHTML="";
    if(view!=="week") return;
    const weeks = Array.from(new Set(weeklyData.filter(r=>r.month===CURRENT_MONTH).map(r=>r.week))).sort();
    weeks.forEach(w=>{
      const btn=document.createElement("button"); btn.innerText=w;
      btn.onclick=()=>setWeek(Number(w.replace("Week ","")),btn);
      if(selectedWeek===Number(w.replace("Week ",""))) btn.classList.add("active");
      weekSelector.appendChild(btn);
    });
  }

  function loadData(){
    Promise.all([
      fetch(YEARLY_CSV+"&t="+Date.now()).then(r=>r.text()),
      fetch(WEEKLY_CSV+"&t="+Date.now()).then(r=>r.text())
    ]).then(([y,w])=>{
      weeklyData=w.trim().split("\n").slice(1).map(r=>{
        const c=r.split(",");
        return { name:(c[2]||"").trim(), week:(c[3]||"").trim(), value:Number(c[4])||0, month:(c[5]||"").trim() };
      });
      const people=y.trim().split("\n").slice(1).map(r=>{ const c=r.split(","); return {name:c[0],goal:+c[1],ytd:+c[2],total:0}; });

      // ‚úÖ Person totals filter by month/week
      people.forEach(p=>{
        if(view==="ytd"){
          weeklyData.forEach(r=>{
            if(r.name===p.name && (!selectedYearMonth || r.month===selectedYearMonth)) p.total+=r.value;
          });
          return;
        }
        weeklyData.forEach(r=>{
          if(r.name!==p.name) return;
          if(view==="month" && r.month===CURRENT_MONTH) p.total+=r.value;
          if(view==="week" && r.week===`Week ${selectedWeek||1}` && r.month===CURRENT_MONTH) p.total+=r.value;
        });
      });

      render(people);
      renderWeekButtons();
    });
  }

  function render(people){
    const dash=document.getElementById("dashboard"); const mgr=document.getElementById("managers");
    dash.innerHTML=""; mgr.innerHTML="";
    const racers=people.filter(p=>!MANAGERS.includes(p.name));
    const managers=people.filter(p=>MANAGERS.includes(p.name));
    racers.sort((a,b)=>b.total-a.total);

    // ‚úÖ TEAM TOTAL FIX: always sum all enrollments regardless of month/week
    const teamTotal = weeklyData.reduce((sum,r)=>sum+r.value,0);
    const teamPct=pct(teamTotal,TEAM_GOAL);

    [25,50,75,100].forEach(m=>{ if(teamPct>=m && !celebrated[m]){ fire(); celebrated[m]=true; } });

    document.getElementById("team").innerHTML=`
      <div class="card team">
        <h3>üèÅ Team Goal</h3>
        <div class="progress"><div class="bar" style="width:${teamPct}%; --pct:${teamPct}%"><span class="car">üèéÔ∏è</span></div></div>
        <p>${teamTotal} / ${TEAM_GOAL} (${teamPct}%)</p>
      </div>`;

    const mvp=racers[0]; const mvpEl=document.getElementById("mvp");
    mvpEl.classList.toggle("active",!!mvp);
    if(mvp && lastMVP!==mvp.name){ fire(); lastMVP=mvp.name; }
    mvpEl.innerHTML=mvp?`üèÜ MVP<br><strong>${mvp.name}</strong><br>${mvp.total}`:`üèÜ MVP<br>Waiting‚Ä¶`;

    document.getElementById("podium").innerHTML=`<h3>üèÅ Podium</h3>`+
      racers.slice(0,3).map((p,i)=>`<div class="podium-row">${["ü•á","ü•à","ü•â"][i]} ${p.name}<span>${p.total}</span></div>`).join("");

    racers.forEach((p,i)=>{
      dash.innerHTML+=`<div class="card ${i===0&&p.total>0?"leader":""}">
        ${i===0&&p.total>0?`<div class="mvp-badge">${lastMVP===p.name?"DEFENDING MVP":"MVP"}</div>`:""}
        <h3>${p.name}</h3>
        <div class="progress"><div class="bar" style="width:${pct(p.total,p.goal)}%; --pct:${pct(p.total,p.goal)}%"><span class="car">üèéÔ∏è</span></div></div>
        <p>${p.total} / ${p.goal}</p>
      </div>`;
    });

    managers.forEach(p=>{
      mgr.innerHTML+=`<div class="card manager-card">
        <h3>${p.name}</h3>
        <div class="progress"><div class="bar" style="width:${pct(p.total,p.goal)}%; --pct:${pct(p.total,p.goal)}%"><span class="car">üèéÔ∏è</span></div></div>
        <p>${p.total} / ${p.goal}</p>
      </div>`;
    });

    document.getElementById("lapCounter").innerText=
      teamPct>=100?"üèÅ Finished":teamPct>=75?"Final Lap":teamPct>=50?"Lap 3":teamPct>=25?"Lap 2":"Lap 1";
  }

  applyTheme();
  startFallingTheme();
  loadData();
</script>
</body>
</html>

