<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üèÅ Enrollment Race to 550</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
/* ================= CARTOON RACETRACK BACKGROUND ================= */
body{
  margin:0;
  padding:30px 12px;
  font-family:Arial, sans-serif;
  text-align:center;

  background:
    repeating-linear-gradient(
      90deg,
      #86efac 0 60px,
      #a7f3d0 60px 120px
    );
}

/* ================= TITLE ================= */
h1{
  color:#ef4444;
  font-size:30px;
  margin-bottom:20px;
}

/* ================= BUTTONS ================= */
.buttons button{
  margin:5px;
  padding:10px 18px;
  border-radius:16px;
  border:none;
  background:#fff;
  font-weight:bold;
  cursor:pointer;
}

/* ================= CARDS ================= */
.card{
  background:#fff;
  color:#000;
  max-width:380px;
  margin:18px auto;
  padding:20px;
  border-radius:26px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
}

/* ================= TEAM CARD ================= */
.team{
  border:4px solid #ef4444;
}

/* ================= PROGRESS ================= */
.progress{
  background:#e5e7eb;
  height:20px;
  border-radius:14px;
  overflow:hidden;
  margin:14px 0;
}

.bar{
  height:100%;
  position:relative;
  transition:width .6s ease;
  background:linear-gradient(90deg,#facc15,#22c55e);
}

.bar::after{
  content:"üèéÔ∏èüí®";
  position:absolute;
  right:-6px;
  top:-16px;
  font-size:20px;
}

/* ================= MVP ================= */
#mvp{
  position:fixed;
  top:16px;
  left:16px;
  background:#fff7ed;
  border:4px solid #f59e0b;
  border-radius:22px;
  padding:16px 22px;
  min-width:210px;
  box-shadow:0 0 18px rgba(245,158,11,.8);
  animation:pulse 2s infinite;
  text-align:left;
  z-index:1000;
}

#mvp strong{
  display:block;
  font-size:18px;
}

@keyframes pulse{
  0%{transform:scale(1)}
  50%{transform:scale(1.05)}
  100%{transform:scale(1)}
}

/* ================= MODAL ================= */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  align-items:center;
  justify-content:center;
}

.modal-content{
  background:#fff;
  padding:20px;
  border-radius:18px;
  max-width:420px;
}

.close{
  cursor:pointer;
  float:right;
}
</style>
</head>

<body>

<h1>üèÅ Enrollment Race to 550</h1>

<div class="buttons">
  <button onclick="setView('ytd')">Year to Date</button>
  <button onclick="setView('month')">This Month</button>
  <button onclick="setView('week')">This Week</button>
</div>

<div id="mvp"></div>
<div id="team"></div>
<div id="dashboard"></div>

<div class="modal" id="popup">
  <div class="modal-content">
    <span class="close" onclick="closePopup()">‚úñ</span>
    <div id="popupContent"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const TEAM_GOAL = 550;

/* üîó GOOGLE SHEETS ‚Äì LIVE */
const YEARLY_CSV =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vTDtYk0GQ5RzrRT_SBmcjH1TfE3k_kHJ5Sd7nmnoKr81UiDPHXF42gd46qCAuAW5hpwjdKC-6-P8bji/pub?gid=1984389436&single=true&output=csv";

const WEEKLY_CSV =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vTDtYk0GQ5RzrRT_SBmcjH1TfE3k_kHJ5Sd7nmnoKr81UiDPHXF42gd46qCAuAW5hpwjdKC-6-P8bji/pub?gid=0&single=true&output=csv";

const COLORS={
  "Leeah":"#facc15",
  "Marissa":"#f472b6",
  "Chakri":"#fb923c",
  "Nitya":"#3b82f6"
};

let view="month";
let weeklyData=[];

/* ================= HELPERS ================= */
function pct(a,b){return b?Math.round(a/b*100):0;}

/* ================= CONFETTI (50% ONCE) ================= */
function celebrate(key){
  if(localStorage.getItem(key)) return;
  confetti({particleCount:160,spread:90,origin:{y:.6}});
  localStorage.setItem(key,"done");
}

/* ================= VIEW ================= */
function setView(v){view=v;loadData();}

/* ================= LOAD DATA ================= */
function loadData(){
  Promise.all([
    fetch(YEARLY_CSV).then(r=>r.text()),
    fetch(WEEKLY_CSV).then(r=>r.text())
  ]).then(([y,w])=>{

    weeklyData=w.trim().split("\n").slice(1).map(r=>{
      const c=r.split(",");
      return{date:new Date(c[0]),name:c[1],value:+c[2]||0};
    });

    const people=y.trim().split("\n").slice(1).map(r=>{
      const c=r.split(",");
      return{name:c[0],goal:+c[1],ytd:+c[2],total:0};
    });

    const now=new Date();

    people.forEach(p=>{
      if(view==="ytd"){p.total=p.ytd;return;}
      weeklyData.forEach(r=>{
        if(r.name!==p.name) return;
        const d=(now-r.date)/86400000;
        if(view==="week"&&d>=0&&d<=7) p.total+=r.value;
        if(view==="month"&&
           r.date.getMonth()===now.getMonth() &&
           r.date.getFullYear()===now.getFullYear())
           p.total+=r.value;
      });
    });

    render(people);
  });
}

/* ================= RENDER ================= */
function render(people){
  const dash=document.getElementById("dashboard");
  dash.innerHTML="";

  const teamTotal=people.reduce((a,b)=>a+b.total,0);
  const teamPct=pct(teamTotal,TEAM_GOAL);
  if(teamPct>=50) celebrate("team-half");

  document.getElementById("team").innerHTML=`
    <div class="card team">
      <h2>üèÅ Team Goal</h2>
      <div class="progress">
        <div class="bar" style="width:${teamPct}%"></div>
      </div>
      <p>${teamTotal} / ${TEAM_GOAL} (${teamPct}%)</p>
    </div>
  `;

  people.sort((a,b)=>pct(b.total,b.goal)-pct(a.total,a.goal));
  const mvp=people[0];

  document.getElementById("mvp").innerHTML=`
    üèÜ MVP (${view.toUpperCase()})
    <strong>${mvp.name}</strong>
    ${mvp.total} enrollments
  `;

  people.forEach(p=>{
    const pPct=pct(p.total,p.goal);
    if(pPct>=50) celebrate("half-"+p.name);

    dash.innerHTML+=`
      <div class="card" onclick="showPopup('${p.name}')">
        <h2>${p.name}</h2>
        <div class="progress">
          <div class="bar" style="width:${pPct}%;background:linear-gradient(90deg,${COLORS[p.name]},#22c55e)"></div>
        </div>
        <p>${p.total} / ${p.goal} (${pPct}%)</p>
      </div>
    `;
  });
}

/* ================= POPUP ================= */
function showPopup(name){
  let rows="",total=0;
  const now=new Date();
  weeklyData.forEach(r=>{
    if(r.name===name &&
       r.date.getMonth()===now.getMonth()){
      total+=r.value;
      rows+=`<p>${r.date.toLocaleDateString()}: ${r.value}</p>`;
    }
  });

  document.getElementById("popupContent").innerHTML=`
    <h2>${name} ‚Äì Monthly Breakdown</h2>
    ${rows||"<p>No activity yet</p>"}
    <hr><strong>Total: ${total}</strong>
  `;
  document.getElementById("popup").style.display="flex";
}

function closePopup(){
  document.getElementById("popup").style.display="none";
}

loadData();
</script>

</body>
</html>
